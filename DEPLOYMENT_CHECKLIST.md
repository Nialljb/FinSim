# üöÄ Deployment Checklist for Render

## Pre-Deployment (Before Pushing to GitHub)

### ‚úÖ Code Preparation
- [ ] All code committed to `budget` branch
- [ ] `database.py` updated with PostgreSQL URL fix (‚úÖ Done)
- [ ] `migrate_add_currency_to_budgets.py` supports PostgreSQL (‚úÖ Done)
- [ ] `.gitignore` excludes sensitive files (‚úÖ Done)
- [ ] `requirements.txt` is up to date
- [ ] `render.yaml` configured correctly

### ‚úÖ Test Locally
```bash
# Verify all dependencies install
pip install -r requirements.txt

# Test database initialization
python -c "from database import init_db; init_db()"

# Test migration script
python migrate_add_currency_to_budgets.py

# Test analytics export
python analytics_module.py

# Run the app
streamlit run wealth_simulator.py
```

---

## Deployment to Render

### 1Ô∏è‚É£ Push to GitHub
```bash
git add .
git commit -m "Added PostgreSQL support and analytics module"
git push origin budget
```

### 2Ô∏è‚É£ Render Dashboard Setup

**Create/Update Web Service:**
1. Go to [dashboard.render.com](https://dashboard.render.com)
2. Connect your GitHub repository
3. Select `budget` branch
4. Use existing `render.yaml` configuration

**Create Database (if not exists):**
1. Create new PostgreSQL database: `finsim-db`
2. Plan: Free (1GB, expires after 90 days) or Standard ($7/month)
3. Region: Choose closest to users

**Link Database to Web Service:**
1. Web Service ‚Üí Environment tab
2. Add environment variable:
   - Key: `DATABASE_URL`
   - Value: Link to database (Render does this automatically via render.yaml)

### 3Ô∏è‚É£ First Deploy Actions

**After first successful deploy:**

1. **Initialize Database Tables:**
   - Go to Web Service ‚Üí Shell tab
   - Run:
   ```bash
   python -c "from database import init_db; init_db()"
   ```

2. **Run Migrations:**
   ```bash
   python migrate_add_currency_to_budgets.py
   ```

3. **Verify Database:**
   - Go to Database ‚Üí Connect tab
   - Open SQL Editor
   - Run:
   ```sql
   SELECT table_name FROM information_schema.tables WHERE table_schema='public';
   ```
   - Should see: `users`, `simulations`, `saved_budgets`, `usage_stats`

4. **Test App:**
   - Open your Render URL (e.g., `https://finsim-app.onrender.com`)
   - Create a test user account
   - Run a test simulation
   - Save a budget
   - Verify data appears in database

---

## Post-Deployment Configuration

### üîí Security Settings

**Environment Variables to Set (Render Dashboard ‚Üí Web Service ‚Üí Environment):**

| Variable | Purpose | How to Set |
|----------|---------|------------|
| `DATABASE_URL` | Database connection | Auto-set by Render ‚úÖ |
| `SECRET_KEY` | Session encryption | Auto-generated by render.yaml ‚úÖ |
| `FREE_SIMULATION_LIMIT` | Max free sims | Set to `10` in render.yaml ‚úÖ |

### üìä Database Backups

**Enable Automatic Backups:**
1. Database Dashboard ‚Üí Backups tab
2. Enable daily backups
3. Set retention period (7 days on free tier)

**Manual Backup:**
```bash
# From Database ‚Üí Connect tab, copy External Database URL
pg_dump <DATABASE_URL> > backup_$(date +%Y%m%d).sql
```

### üìà Monitoring

**Check Application Logs:**
- Web Service ‚Üí Logs tab
- Monitor for errors on startup
- Watch for database connection issues

**Database Metrics:**
- Database ‚Üí Metrics tab
- Monitor storage usage
- Check connection count

---

## Testing After Deployment

### ‚úÖ Functionality Checklist

**Authentication:**
- [ ] User registration works
- [ ] User login works
- [ ] Sessions persist correctly

**Core Features:**
- [ ] Budget builder saves budgets
- [ ] Budget loading populates all fields
- [ ] Budget currency is saved/loaded correctly
- [ ] Simulation runs successfully
- [ ] Simulation saves with all parameters
- [ ] Simulation loading restores state
- [ ] Multi-currency conversion works

**Database:**
- [ ] Users table populated on registration
- [ ] Simulations table records new runs
- [ ] SavedBudgets table stores budgets
- [ ] UsageStats tracks activity
- [ ] All user_id foreign keys work correctly

**Analytics:**
- [ ] Can query database via SQL Editor
- [ ] Analytics module generates data
- [ ] Export downloads work (if implemented)

---

## Troubleshooting Common Issues

### Issue: "No such table" Error
**Solution:**
```bash
# In Render Shell
python -c "from database import init_db; init_db()"
```

### Issue: "Column does not exist: currency"
**Solution:**
```bash
python migrate_add_currency_to_budgets.py
```

### Issue: Database Connection Timeout
**Cause:** Free tier database sleeps after inactivity
**Solution:**
- Upgrade to paid tier, OR
- Add retry logic (already in code)
- Expect 10-30 second wake-up time

### Issue: App Crashes on Startup
**Check:**
1. Logs for error messages
2. DATABASE_URL is set correctly
3. All dependencies in requirements.txt
4. Python version matches (3.11.0)

### Issue: Can't Access Database Externally
**Solution:**
- Free tier: External access included
- Check firewall/network settings
- Verify connection string is correct
- Use Internal Database URL from within Render services

---

## Database Access Methods

### Method 1: Render SQL Editor (Easiest)
1. Database Dashboard ‚Üí Connect ‚Üí SQL Editor
2. Run queries directly in browser

### Method 2: psql CLI
```bash
# Copy External Database URL from Render
psql <DATABASE_URL>

# Useful commands:
\dt              # List tables
\d users         # Describe users table
\q               # Quit
```

### Method 3: GUI Client (DBeaver/TablePlus)
1. Download client
2. Create PostgreSQL connection
3. Enter connection details from Render

---

## Analytics Export on Render

### Option 1: Streamlit Download Buttons (Recommended)

Add to `wealth_simulator.py`:

```python
import streamlit as st
from analytics_module import export_all_analytics

# In your app (after login)
with st.expander("üìä Export Analytics Data"):
    if st.button("Generate Analytics Reports"):
        with st.spinner("Generating analytics..."):
            exports = export_all_analytics()
            
            st.success("‚úÖ Analytics ready for download!")
            
            cols = st.columns(2)
            for idx, (name, df) in enumerate(exports.items()):
                col = cols[idx % 2]
                if len(df) > 0:
                    csv = df.to_csv(index=False)
                    col.download_button(
                        label=f"üì• {name.replace('_', ' ').title()}",
                        data=csv,
                        file_name=f"{name}.csv",
                        mime="text/csv",
                        key=f"dl_{name}"
                    )
```

### Option 2: Run Analytics via Shell
```bash
# In Render Shell
python analytics_module.py
# Note: Files won't persist, use for testing only
```

### Option 3: SQL Queries (Manual)
Use SQL Editor to run custom queries for analysis:

```sql
-- Age-based income analysis
SELECT 
    FLOOR(u.current_age / 5) * 5 as age_bracket,
    s.income_bracket,
    COUNT(*) as count,
    AVG((s.parameters->>'gross_annual_income')::numeric) as avg_income
FROM users u
JOIN simulations s ON u.id = s.user_id
GROUP BY age_bracket, s.income_bracket
ORDER BY age_bracket, s.income_bracket;
```

---

## Maintenance

### Weekly Tasks
- [ ] Check application logs for errors
- [ ] Monitor database storage (free tier = 1GB limit)
- [ ] Review usage statistics

### Monthly Tasks
- [ ] Review and analyze user data
- [ ] Export analytics for reports
- [ ] Clean up old test accounts (if any)

### As Needed
- [ ] Update dependencies (security patches)
- [ ] Run new database migrations
- [ ] Scale up if hitting free tier limits

---

## Useful Links

- **Render Dashboard:** https://dashboard.render.com
- **Render Docs - PostgreSQL:** https://render.com/docs/databases
- **Render Docs - Environment Variables:** https://render.com/docs/environment-variables
- **SQLAlchemy Docs:** https://docs.sqlalchemy.org/
- **Streamlit Docs:** https://docs.streamlit.io/

---

## Support Resources

- See `docs/RENDER_DATABASE_MANAGEMENT.md` for detailed database management guide
- See `docs/DATABASE_ACCESS_GUIDE.md` for SQL query examples
- See `docs/DEPLOYMENT_GUIDE.md` for full deployment documentation

---

**Last Updated:** November 28, 2025
